<script>
    
function abrirModalRegistro() {
  document.getElementById('modalRegistro').classList.add('active');
  document.getElementById('formRegistro').reset();
  
  // Establecer valores por defecto
  document.getElementById('estado').value = 'En Revisi√≥n';
  document.getElementById('tipoPlaga').value = 'N/A';
  
  // Establecer fecha m√≠nima como hoy para el campo de fecha
  const fechaInput = document.getElementById('fechaRetorno');
  if (fechaInput) {
    const hoy = new Date();
    
    // CORRECCI√ìN: Formatear fecha correctamente para input type="date"
    const fechaHoy = hoy.toISOString().split('T')[0];
    fechaInput.min = fechaHoy;
    
    // Establecer fecha por defecto (3 d√≠as despu√©s)
    const fechaDefecto = new Date();
    fechaDefecto.setDate(hoy.getDate() + 3);
    const fechaDefectoStr = fechaDefecto.toISOString().split('T')[0];
    fechaInput.value = fechaDefectoStr;
  }
}

function cerrarModalRegistro() {
  // 1. Cerrar el modal
  document.getElementById('modalRegistro').classList.remove('active');
  
  // 2. Limpiar el formulario (por si acaso)
  setTimeout(() => {
    document.getElementById('formRegistro').reset();
    
    // 3. Restablecer valores por defecto
    document.getElementById('estado').value = 'En Revisi√≥n';
    document.getElementById('tipoPlaga').value = 'N/A';
  }, 300);
}

function guardarRegistro(event) {
  if (event) event.preventDefault();
  
  const btnGuardar = document.querySelector('#formRegistro button[type="submit"]');
  const textoOriginal = btnGuardar.innerHTML;
  btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
  btnGuardar.disabled = true;
  
  // Validar que el campo de fecha existe
  const fechaRetornoInput = document.getElementById('fechaRetorno');
  if (!fechaRetornoInput) {
    mostrarNotificacion('Error: Campo de fecha no encontrado', 'error');
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    return;
  }
  
  // Validar fecha de retorno
  const fechaRetornoValor = fechaRetornoInput.value;
  if (!fechaRetornoValor) {
    mostrarNotificacion('La fecha de retorno es requerida', 'error');
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    return;
  }
  
  // CORRECCI√ìN: Manejar fecha correctamente sin problemas de zona horaria
  const fechaRetorno = new Date(fechaRetornoValor + 'T00:00:00'); // Agregar tiempo para evitar ajuste de zona horaria
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  
  if (fechaRetorno < hoy) {
    mostrarNotificacion('La fecha de retorno no puede ser anterior a hoy', 'error');
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    return;
  }
  
  // CORRECCI√ìN: Enviar la fecha en formato YYYY-MM-DD sin problemas de zona horaria
  const datos = {
    'C√≥digo': document.getElementById('codigo').value.trim(),
    'NombreProducto': document.getElementById('nombreproducto').value.trim(),
    'Descripci√≥n': document.getElementById('descripcion').value.trim(),
    'Tipo de Salida': document.getElementById('tipoSalida').value,
    'Tipo de Plaga/Hallazgo': document.getElementById('tipoPlaga').value,
    'Responsable': document.getElementById('responsable').value.trim(),
    'Pasillo/Ubicaci√≥n': document.getElementById('pasillo').value.trim(),
    'Fecha Estimada de Retorno': fechaRetornoValor, // Enviar el valor original del input
    'Estado': document.getElementById('estado').value
  };
  
  // Validar campos requeridos
  const camposRequeridos = ['C√≥digo', 'NombreProducto', 'Descripci√≥n', 'Tipo de Salida', 'Responsable', 'Pasillo/Ubicaci√≥n', 'Fecha Estimada de Retorno', 'Estado'];
  const camposFaltantes = camposRequeridos.filter(campo => !datos[campo]);
  
  if (camposFaltantes.length > 0) {
    mostrarNotificacion('Por favor complete todos los campos requeridos', 'error');
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    return;
  }
  
  mostrarLoading(true);
  
  const timeoutId = setTimeout(() => {
    mostrarLoading(false);
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
    mostrarNotificacion('El registro est√° tardando demasiado. Intente nuevamente.', 'warning');
  }, 10000);
  
  timeoutIds.push(timeoutId);
  
  google.script.run
    .withSuccessHandler((resultado) => {
      clearTimeout(timeoutId);
      respuestaGuardar(resultado, btnGuardar, textoOriginal);
    })
    .withFailureHandler((error) => {
      clearTimeout(timeoutId);
      errorGuardar(error, btnGuardar, textoOriginal);
    })
    .registrarSalida(datos);
}

function respuestaGuardar(resultado, btnGuardar, textoOriginal) {
  console.log('üìù Respuesta de guardar:', resultado);
  console.log('üìù Tipo de respuesta:', typeof resultado);
  mostrarLoading(false);
  
  // REHABILITAR bot√≥n siempre
  if (btnGuardar) {
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
  }
  
  // ‚úÖ CORRECCI√ìN MEJORADA: Manejar tanto objetos como strings JSON
  let respuestaFinal = resultado;
  
  // Si es string, intentar parsear
  if (typeof resultado === 'string') {
    try {
      respuestaFinal = JSON.parse(resultado);
      console.log('üìä Respuesta parseada:', respuestaFinal);
    } catch (e) {
      console.error('‚ùå Error parseando JSON:', e);
      mostrarNotificacion('Error: Respuesta inv√°lida del servidor', 'error');
      return;
    }
  }
  
  if (!respuestaFinal || typeof respuestaFinal !== 'object') {
    console.error('‚ùå Error: Respuesta inv√°lida:', respuestaFinal);
    mostrarNotificacion('Error: Formato de respuesta inv√°lido', 'error');
    return;
  }
  
  // ‚úÖ VERIFICAR SI FUE EXITOSO
  if (respuestaFinal.success === true) {
    console.log('‚úÖ Registro exitoso, ID:', respuestaFinal.id);
    
    // 1. Cerrar el modal
    cerrarModalRegistro();
    
    // 2. Limpiar el formulario
    document.getElementById('formRegistro').reset();
    
    // 3. Mostrar alerta de √âXITO (verde)
    mostrarNotificacion(`‚úÖ Salida registrada correctamente con ID: ${respuestaFinal.id}`, 'success');
    
    // 4. Actualizar el dashboard autom√°ticamente
    setTimeout(() => {
      cargarDashboard();
    }, 1500); // Esperar 1.5 segundos antes de actualizar
    
  } else {
    // ‚ùå Mostrar error si fall√≥
    console.error('‚ùå Error en registro:', respuestaFinal.message);
    mostrarNotificacion('‚ùå Error al registrar: ' + (respuestaFinal.message || 'Error desconocido'), 'error');
  }
}

function errorGuardar(error, btnGuardar, textoOriginal) {
  mostrarLoading(false);
  
  // REHABILITAR bot√≥n siempre
  if (btnGuardar) {
    btnGuardar.innerHTML = textoOriginal;
    btnGuardar.disabled = false;
  }
  
  console.error('‚ùå Error del servidor:', error);
  mostrarNotificacion('Error del servidor: ' + (error.message || 'Error desconocido'), 'error');
}

function cargarOpcionesFormulario() {
  google.script.run
    .withSuccessHandler((opciones) => {
      if (!opciones || typeof opciones !== 'object') {
        console.error('‚ùå Opciones inv√°lidas:', opciones);
        return;
      }
      
      llenarSelect('tipoSalida', opciones.tiposSalida);
      llenarSelect('tipoPlaga', opciones.tiposPlagas);
      llenarSelect('estado', opciones.estados);
    })
    .withFailureHandler((error) => {
      console.error('‚ùå Error al cargar opciones:', error);
      // Usar opciones por defecto incluyendo "Vencido"
      llenarSelect('tipoSalida', ['Control de Calidad', 'Gasificaci√≥n', 'Destrucci√≥n', 'Para Revisi√≥n', 'Reproceso', 'Devoluci√≥n a Proveedor', 'Otro']);
      llenarSelect('tipoPlaga', ['N/A', 'Insectos', 'Roedores', 'Hongos', 'Contaminaci√≥n', 'Otro']);
      llenarSelect('estado', ['En Revisi√≥n', 'Devuelto', 'Pendiente por Devoluci√≥n', 'Procesado', 'Destruido', 'Vencido']);
    })
    .obtenerOpciones();
}
</script>