<script>

function crearGraficos(stats) {
  if (!stats) {
    console.warn('‚ö†Ô∏è No hay estad√≠sticas para crear gr√°ficos');
    return;
  }
  
  // Destruir gr√°ficos anteriores
  Object.values(charts).forEach(chart => {
    if (chart && typeof chart.destroy === 'function') {
      chart.destroy();
    }
  });
  charts = {};
  
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'bottom',
        labels: {
          font: {
            family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif',
            size: 12
          },
          padding: 15
        }
      }
    }
  };
  
  const coloresCalidos = [
    '#FDB913', '#F59E0B', '#FBBF24', '#FCD34D', 
    '#FDE047', '#FEF08A', '#FFE5B4', '#FFDAB9'
  ];
  
  // Gr√°fico de Tipo de Salida
  crearGraficoIndividual(
    'chartTipoSalida', 
    'doughnut', 
    stats.porTipoSalida, 
    coloresCalidos,
    commonOptions
  );
  
  // Gr√°fico de Tipo de Plaga
crearGraficoIndividual(
  'chartTipoPlaga',
  'bar',
  stats.porTipoPlaga,
  ['#FDB913'],
  {
    ...commonOptions,
    scales: {
      y: {
        beginAtZero: true,
        ticks: { 
          stepSize: 1,
          font: {
            size: 11
          }
        }
      },
      x: {
        ticks: {
          font: {
            size: 10, // Un poco m√°s peque√±o para que quepan m√°s
            family: '-apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif'
          },
          maxRotation: 45, // Inclinar 45 grados para que quepan m√°s
          minRotation: 45, // Forzar inclinaci√≥n
          autoSkip: false, // ‚Üê IMPORTANTE: Mostrar todas las etiquetas
          includeBounds: true,
          callback: function(value, index) {
            // value es el √≠ndice, necesitamos los labels originales
            const labels = this.chart.data.labels;
            const originalLabel = labels[index];
            
            if (!originalLabel) return '';
            
            // Limitar a 10 caracteres m√°ximo (m√°s corto para que quepan m√°s)
            const maxChars = 10;
            if (originalLabel.length > maxChars) {
              return originalLabel.substring(0, maxChars - 3) + '...';
            }
            return originalLabel;
          }
        },
        // Ajustar el grid para que quepan m√°s etiquetas
        grid: {
          offset: true
        }
      }
    },
    // Ajustar el layout para mejor espacio
    layout: {
      padding: {
        left: 10,
        right: 10,
        top: 10,
        bottom: 20
      }
    }
  }
);
  
  // Gr√°fico de Pasillo
  crearGraficoIndividual(
    'chartPasillo',
    'bar',
    stats.porPasillo,
    ['#F59E0B'],
    {
      ...commonOptions,
      indexAxis: 'y',
      scales: {
        x: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      }
    }
  );
  
  // Gr√°fico de Estado
  crearGraficoIndividual(
    'chartEstado',
    'pie',
    stats.porEstado,
    coloresCalidos,
    commonOptions
  );
}

function crearGraficoIndividual(canvasId, tipo, datos, colores, opciones) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) {
    console.error(`‚ùå No se encontr√≥ el canvas: ${canvasId}`);
    return;
  }
  
  const parent = canvas.parentElement;
  
  const canvasExistente = document.getElementById(canvasId);
  if (canvasExistente) {
    canvasExistente.remove();
  }
  
  const mensajesAnteriores = parent.querySelectorAll('.no-data-message, .error-message');
  mensajesAnteriores.forEach(msg => msg.remove());

  if (charts[canvasId]) {
    charts[canvasId].destroy();
  }

  const nuevoCanvas = document.createElement('canvas');
  nuevoCanvas.id = canvasId;
  
  nuevoCanvas.style.width = '100%';
  nuevoCanvas.style.height = '300px';
  nuevoCanvas.style.minHeight = '300px';
  nuevoCanvas.style.maxHeight = '300px';
  
  parent.appendChild(nuevoCanvas);
  
  if (!datos || Object.keys(datos).length === 0) {
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = 'no-data-message';
    mensajeDiv.innerHTML = '<p>No hay datos disponibles</p>';
    mensajeDiv.style.height = '300px';
    mensajeDiv.style.display = 'flex';
    mensajeDiv.style.alignItems = 'center';
    mensajeDiv.style.justifyContent = 'center';
    parent.appendChild(mensajeDiv);
    return;
  }
  
  const datosFiltrados = {};
  Object.keys(datos).forEach(key => {
    if (datos[key] > 0) {
      datosFiltrados[key] = datos[key];
    }
    console.log(`üîç Etiquetas para ${canvasId}:`, Object.keys(datos));
  });
  
  if (Object.keys(datosFiltrados).length === 0) {
    const mensajeDiv = document.createElement('div');
    mensajeDiv.className = 'no-data-message';
    mensajeDiv.innerHTML = '<p>No hay datos disponibles</p>';
    mensajeDiv.style.height = '300px';
    mensajeDiv.style.display = 'flex';
    mensajeDiv.style.alignItems = 'center';
    mensajeDiv.style.justifyContent = 'center';
    parent.appendChild(mensajeDiv);
    return;
  }
  
  const ctx = nuevoCanvas.getContext('2d');
  
  try {
    charts[canvasId] = new Chart(ctx, {
      type: tipo,
      data: {
        labels: Object.keys(datosFiltrados),
datasets: [{
  label: obtenerLabelGrafico(canvasId, tipo),
  data: Object.values(datosFiltrados),
  backgroundColor: colores,
  borderWidth: 2,
  borderColor: '#fff',
  borderRadius: tipo === 'bar' ? 8 : 0
}]
      },
      options: {
        ...opciones,
        responsive: true,
        maintainAspectRatio: false
      }
    });
  } catch (error) {
    console.error(`‚ùå Error creando gr√°fico ${canvasId}:`, error);
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.innerHTML = '<p>Error al crear gr√°fico</p>';
    errorDiv.style.height = '300px';
    errorDiv.style.display = 'flex';
    errorDiv.style.alignItems = 'center';
    errorDiv.style.justifyContent = 'center';
    parent.appendChild(errorDiv);
  }
}

// Funci√≥n para obtener la leyenda correcta de cada gr√°fico
function obtenerLabelGrafico(canvasId, tipo) {
  const labels = {
    'chartTipoSalida': 'Tipos de Salida',
    'chartTipoPlaga': 'Cantidad',  
    'chartPasillo': 'Cantidad',    
    'chartEstado': 'Estados'
  };
  
  // Si no est√° en la lista, usar valor por defecto
  return labels[canvasId] || (tipo === 'bar' ? 'Cantidad' : '');
}

function actualizarEstadisticas(stats) {
  if (!stats) {
    console.warn('‚ö†Ô∏è Stats es null o undefined');
    stats = {
      totalSalidas: 0,
      porEstado: {}
    };
  }
  
  document.getElementById('totalSalidas').textContent = stats.totalSalidas || 0;
  document.getElementById('enRevision').textContent = (stats.porEstado && stats.porEstado['En Revisi√≥n']) || 0;
  document.getElementById('devueltos').textContent = (stats.porEstado && stats.porEstado['Devuelto']) || 0;
  document.getElementById('pendientes').textContent = (stats.porEstado && stats.porEstado['Pendiente por Devoluci√≥n']) || 0;
}

</script>