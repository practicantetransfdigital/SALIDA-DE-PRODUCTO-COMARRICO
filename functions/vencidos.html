<script>

function cargarDashboard() {
  if (cargandoDashboard) {
    console.log('üîÑ Dashboard ya se est√° cargando, ignorando llamada duplicada');
    return;
  }
  
  console.log('üîÑ Iniciando carga de dashboard...');
  cargandoDashboard = true;
  mostrarLoading(true);
  
  const timeoutId = setTimeout(() => {
    mostrarLoading(false);
    cargandoDashboard = false;
    mostrarNotificacion('La carga est√° tardando demasiado. Verifique su conexi√≥n.', 'warning');
  }, 15000);
  
  timeoutIds.push(timeoutId);
  
  google.script.run
    .withSuccessHandler((resultado) => {
      clearTimeout(timeoutId);
      cargandoDashboard = false;
      respuestaDashboard(resultado);
    })
    .withFailureHandler((error) => {
      clearTimeout(timeoutId);
      cargandoDashboard = false;
      errorDashboard(error);
    })
    .obtenerDatosDashboard();
  
  // Cargar opciones para el formulario en paralelo
  cargarOpcionesFormulario();
}

function respuestaDashboard(resultado) {
  console.log('‚úÖ Respuesta del dashboard:', resultado);
  mostrarLoading(false);
  
  if (resultado === null || resultado === undefined) {
    console.error('‚ùå ERROR: El servidor devolvi√≥ null/undefined');
    // Solo mostrar error si estamos en la pantalla principal
    if (document.getElementById('mainScreen').classList.contains('active')) {
      mostrarNotificacion('Error: El servidor no respondi√≥ correctamente. Verifique la conexi√≥n y los permisos.', 'error');
    }
    return;
  }
  
  if (typeof resultado === 'string') {
    try {
      resultado = JSON.parse(resultado);
    } catch (e) {
      console.error('‚ùå Error parseando JSON:', e);
      if (document.getElementById('mainScreen').classList.contains('active')) {
        mostrarNotificacion('Error: Respuesta inv√°lida del servidor', 'error');
      }
      return;
    }
  }
  
  if (!resultado || typeof resultado !== 'object') {
    console.error('‚ùå Error: Respuesta inv√°lida:', resultado);
    if (document.getElementById('mainScreen').classList.contains('active')) {
      mostrarNotificacion('Error: Formato de respuesta inv√°lido', 'error');
    }
    return;
  }
  
  if (resultado.success === false) {
    console.error('‚ùå Error del servidor:', resultado.message);
    if (document.getElementById('mainScreen').classList.contains('active')) {
      mostrarNotificacion('Error: ' + resultado.message, 'error');
    }
    return;
  }
  
  if (resultado.success === true) {
    console.log('‚úÖ Dashboard cargado exitosamente');
    datosCompletos = resultado;
    
    // Solo actualizar la UI si estamos en la pantalla principal
    if (document.getElementById('mainScreen').classList.contains('active')) {
      actualizarEstadisticas(resultado.estadisticas || {});
      crearGraficos(resultado.estadisticas || {});
      cargarTabla((resultado.estadisticas && resultado.estadisticas.ultimosRegistros) || []);
      mostrarNotificacion('Dashboard actualizado correctamente', 'success');
      
      // Verificar vencimientos despu√©s de cargar los datos
      setTimeout(verificarVencimientos, 1000);
      
      setTimeout(actualizarContadorVencidosEnDashboard, 500);
    }
  } else {
    console.error('‚ùå Respuesta sin propiedad success:', resultado);
    if (document.getElementById('mainScreen').classList.contains('active')) {
      mostrarNotificacion('Error: Formato de respuesta inv√°lido', 'error');
    }
  }
}

function errorDashboard(error) {
  mostrarLoading(false);
  console.error('‚ùå Error del servidor:', error);
  
  let mensaje = 'Error del servidor: ' + (error.message || 'Error desconocido');
  mensaje += '\n\nSugerencias:';
  mensaje += '\n‚Ä¢ Verifique su conexi√≥n a internet';
  mensaje += '\n‚Ä¢ Confirme que la aplicaci√≥n est√© desplegada';
  mensaje += '\n‚Ä¢ Contacte al administrador del sistema';
  
  mostrarNotificacion(mensaje, 'error');
}

</script>