<script>

function cargarOpcionesEstado() {
  const selectEstado = document.getElementById('editarEstado');
  selectEstado.innerHTML = '<option value="">Seleccione nuevo estado...</option>';
  
  // Usar las mismas opciones que el formulario principal
  const opcionesEstado = [
    'En Revisión', 'Devuelto', 'Pendiente por Devolución', 'Procesado', 'Destruido'
  ];
  
  opcionesEstado.forEach(estado => {
    const option = document.createElement('option');
    option.value = estado;
    option.textContent = estado;
    selectEstado.appendChild(option);
  });
  
  // Event listener para actualizar vista previa - CORREGIDO: eliminar .clase
  selectEstado.addEventListener('change', function() {
    const nuevoEstado = this.value;
    const estadoNuevoElement = document.getElementById('estadoNuevoTexto');
    
    if (nuevoEstado) {
      estadoNuevoElement.textContent = nuevoEstado;
      estadoNuevoElement.className = 'badge ' + obtenerBadgeEstado(nuevoEstado);
    } else {
      estadoNuevoElement.textContent = 'Seleccione estado';
      estadoNuevoElement.className = 'badge badge-info';
    }
  });
}

async function guardarCambioEstado() {
  if (!registroActual) {
    mostrarNotificacion('No hay registro seleccionado', 'error');
    return;
  }

  const confirmado = await confirmar(`¿Está seguro de cambiar el estado?`);
  const nuevoEstado = document.getElementById('editarEstado').value;
  const observaciones = document.getElementById('editarObservaciones').value.trim();
  
  if (!nuevoEstado) {
    mostrarNotificacion('Por favor seleccione un nuevo estado', 'error');
    return;
  }
  
  if (nuevoEstado === registroActual.Estado) {
    mostrarNotificacion('El estado seleccionado es el mismo que el actual', 'warning');
    return;
  }
  
  if (!confirmado) {
  return;
  }
  
  mostrarLoading(true);

  const nombreUser = usuarioActual.nombre;
  
  google.script.run
    .withSuccessHandler(function(resultado) {
      mostrarLoading(false);
      
      if (resultado && resultado.success) {
        mostrarNotificacion('✅ Estado actualizado correctamente', 'success');
        
        // Recargar datos y mostrar historial actualizado
        cargarDashboard();
        
        // Si estamos en la pestaña de historial, recargarla
        if (pestaniaActual === 'historial') {
          cargarHistorialObservaciones(registroActual.ID);
        }
        
        cerrarModalDetalles();
      } else {
        mostrarNotificacion('❌ Error al actualizar estado: ' + (resultado?.message || 'Error desconocido'), 'error');
      }
    })
    .withFailureHandler(function(error) {
      mostrarLoading(false);
      mostrarNotificacion('❌ Error del servidor: ' + error.message, 'error');
    })
    .actualizarEstadoRegistro(registroActual.ID, nuevoEstado, observaciones, nombreUser);
}

function respuestaCambioEstado(resultado) {
  mostrarLoading(false);
  
  if (resultado && resultado.success) {
    mostrarNotificacion('✅ Estado actualizado correctamente', 'success');
    cerrarModalDetalles();
    cargarDashboard(); // Recargar datos
  } else {
    mostrarNotificacion('❌ Error al actualizar estado: ' + (resultado?.message || 'Error desconocido'), 'error');
  }
}

function errorCambioEstado(error) {
  mostrarLoading(false);
  mostrarNotificacion('❌ Error del servidor: ' + error.message, 'error');
}

</script>