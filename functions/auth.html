<script>
    
function iniciarSesion() {
  const usuario = document.getElementById('usuario').value.trim();
  const contrasena = document.getElementById('contrasena').value;
  
  if (!usuario || !contrasena) {
    mostrarError('Por favor complete todos los campos');
    return;
  }
  
  mostrarLoading(true);
  
  const timeoutId = setTimeout(() => {
    mostrarLoading(false);
    mostrarError('La autenticaci贸n est谩 tardando demasiado. Verifique su conexi贸n.');
  }, 10000);
  
  timeoutIds.push(timeoutId);
  
  google.script.run
    .withSuccessHandler((resultado) => {
      clearTimeout(timeoutId);
      respuestaLogin(resultado);
    })
    .withFailureHandler((error) => {
      clearTimeout(timeoutId);
      errorServidor(error);
    })
    .autenticarUsuario(usuario, contrasena);
}

function respuestaLogin(resultado) {
  mostrarLoading(false); // Ocultar loading del login
  
  if (resultado && resultado.success) {
    usuarioActual = resultado;
    document.getElementById('userName').textContent = resultado.nombre || resultado.usuario;
    document.getElementById('userRole').textContent = resultado.rol;
    document.getElementById('userRole').className = 'badge badge-info';
    
    // Cambiar a la pantalla principal PRIMERO
    cambiarPantalla('mainScreen');
    
    // MOSTRAR LOADING inmediatamente en la pantalla principal
    mostrarLoading(true);
    
    // LUEGO cargar el dashboard
    console.log(' Iniciando carga inmediata del dashboard...');
    cargarDashboard();
    
    // Limpiar formulario de login
    document.getElementById('usuario').value = '';
    document.getElementById('contrasena').value = '';
    limpiarError();
  } else {
    mostrarError(resultado?.message || 'Error desconocido en autenticaci贸n');
  }
}

function cerrarSesion() {
  // Limpiar todos los timeouts pendientes
  timeoutIds.forEach(id => clearTimeout(id));
  timeoutIds = [];
  
  // Destruir gr谩ficos
  Object.values(charts).forEach(chart => {
    if (chart && typeof chart.destroy === 'function') {
      chart.destroy();
    }
  });
  charts = {};
  
  usuarioActual = null;
  datosCompletos = null;
  mostrarNotificacion('Sesi贸n cerrada correctamente', 'info')
  cambiarPantalla('loginScreen');
}
</script>